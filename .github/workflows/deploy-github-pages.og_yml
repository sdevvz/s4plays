name: Deploy to GitHub Pages

on:
  push:
    branches: [main, production]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, gd, json, zip

      - name: ğŸ“¦ Composer Cache
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: ğŸ”„ Cache Composer
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: ğŸ“¦ Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: ğŸŸ¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install NPM Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build Assets
        run: npm run build

      - name: âš™ï¸ Create .env
        run: |
          echo "APP_NAME=AppVault" > .env
          echo "APP_ENV=production" >> .env
          echo "APP_KEY=${{ secrets.APP_KEY }}" >> .env
          echo "APP_DEBUG=false" >> .env
          echo "APP_URL=https://sdeviz.github.io/z4plays" >> .env
          echo "STATAMIC_LICENSE_KEY=${{ secrets.STATAMIC_LICENSE_KEY }}" >> .env

      - name: ğŸ”‘ Generate Key
        run: php artisan key:generate || echo "Key exists"

      - name: ğŸ§¹ Clear Caches
        run: |
          php artisan cache:clear
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear
          php please stache:warm -n -q


      - name: âš¡ Optimize
        run: |
          php artisan route:cache
          php artisan view:cache
          php please stache:warm -n -q


      - name: ğŸ¨ Generate Static Site
        run: php please ssg:generate --workers=4

      - name: âœ… Verify Build
        run: |
          echo "=== Checking static output ==="
          ls -la storage/app/static/ | head -20
          
          echo ""
          echo "=== Checking build directory ==="
          if [ -d "storage/app/static/build" ]; then
            echo "âœ… Build directory exists"
            ls -la storage/app/static/build/ | head -10
          else
            echo "âŒ Build missing - copying..."
            mkdir -p storage/app/static/build
            cp -r public/build/* storage/app/static/build/
          fi
          
          echo ""
          echo "=== Checking HTML ==="
          if [ -f "storage/app/static/index.html" ]; then
            echo "âœ… index.html exists"
            echo "CSS/JS references:"
            grep -o 'href="[^"]*\.css"' storage/app/static/index.html | head -2
            grep -o 'src="[^"]*\.js"' storage/app/static/index.html | head -2
          fi

      - name: ğŸ”§ Fix Paths
        run: |
          cd storage/app/static
          
          # Fix all absolute paths to include /z4plays/
          find . -name "*.html" -type f -exec sed -i \
            -e 's|href="/build/|href="/z4plays/build/|g' \
            -e 's|src="/build/|src="/z4plays/build/|g' \
            -e 's|href="/assets/|href="/z4plays/assets/|g' \
            -e 's|src="/assets/|src="/z4plays/assets/|g' \
            -e 's|href="/images/|href="/z4plays/images/|g' \
            -e 's|src="/images/|src="/z4plays/images/|g' \
            {} \;
          
          echo "âœ… Paths fixed"
          echo "Verify:"
          grep -o 'href="[^"]*build[^"]*"' index.html | head -2

      - name: ğŸ“¤ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'storage/app/static'

  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    permissions:
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4